#!/usr/bin/env bash
# Remove worktrees whose branch no longer exists on origin

# Usage: ./git-prune-worktrees [--dry-run]
# If --dry-run is supplied, the script only reports which worktrees would be removed.

dry_run=false
if [[ "$1" == "--dry-run" ]]; then
    dry_run=true
    echo "Dry‑run mode: no worktrees will be actually removed."
fi

declare -i removed=0

# Generate "branch path" pairs from porcelain output
# shellcheck disable=SC2016
readonly awk_script='
  /^worktree / {path=$2}
  /^branch /   {branch=$2}
  /^$/ {
    if (branch && path) { print branch, path }
    branch=""; path=""
  }
  END {
    if (branch && path) print branch, path
  }
'

# Process each worktree
while read -r branch path; do
    short_branch=${branch#refs/heads/}
    # Remove if branch no longer exists on origin
    if ! git show-ref --verify --quiet "refs/remotes/origin/$short_branch"; then
        # Skip if there are uncommitted changes in the worktree
        if git -C "$path" status --porcelain | grep -q .; then
            echo "Skipping worktree at $path (branch $short_branch) – has uncommitted changes"
            continue
        fi

        if [[ $dry_run == true ]]; then
            echo "Would remove worktree at $path (branch $short_branch)"
        else
            git worktree remove --force "$path"
        fi
        removed=$((removed + 1))
    fi
done < <(git worktree list --porcelain | awk "$awk_script")

if [[ $dry_run == true ]]; then
    echo "Would have removed $removed worktree(s)."
else
    echo "Removed $removed worktree(s)."
fi

